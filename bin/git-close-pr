#!/usr/bin/env bash

current=$(git branchname)
destiny=${1:-master}

# 1. Check if CI is failing
if [[ "$2" != "-f" ]]; then
  ci_status=$(hub ci-status)

  if [[ $ci_status != "success" ]]; then
    echo CI is $ci_status for branch $current
    exit 1
  fi
fi


# 2. Update destiny
git fetch -q
git checkout $destiny -q
# check if branch changed successfully (no staged changes or such things)
[[ $? == 0 ]] || (echo "failed to switch to $destiny" && exit 1)

# 3. Rebase PR branch
git checkout $current -q
git rebase $destiny -q
(git pr-description $current | xclip -selection c || true) &
git rebase -i $destiny

# 4. merge
git push -f -q
git checkout $destiny -q
git merge --ff-only $current -q
git push

# 5. remove branch
[[ $(git diff $current..$destiny) == "" ]] && git nuke $current $destiny > /dev/null

